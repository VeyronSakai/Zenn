---
title: "IPostprocessBuildWithReport ã§å–å¾—ã§ãã‚‹ãƒ“ãƒ«ãƒ‰æƒ…å ±ãŒä¸€éƒ¨èª¤ã£ã¦ã„ã‚‹"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Unity]
published: true
---

## IPostprocessBuildWithReport ã¨ã¯

[IPostprocessBuildWithReport](https://docs.unity3d.com/ScriptReference/Build.IPostprocessBuildWithReport.OnPostprocessBuild.html) ã¯ Unity ã®ãƒ“ãƒ«ãƒ‰å®Œäº†ç›´å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ãŒå®šç¾©ã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™ã€‚ã“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ãƒ“ãƒ«ãƒ‰å¾Œã®å‡¦ç†ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚

ä»¥ä¸‹ã«ã€IPostprocessBuildWithReport ã‚’ä½¿ç”¨ã—ã¦ãƒ“ãƒ«ãƒ‰å¾Œã«ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç¤ºã—ã¾ã™ã€‚

```cs
using UnityEngine;
using UnityEditor;
using UnityEditor.Build;
using UnityEditor.Build.Reporting;

public class Postprocessor : IPostprocessBuildWithReport
{
    public int callbackOrder => 0;

    public void OnPostprocessBuild(BuildReport report) // report ã«ã¯ãƒ“ãƒ«ãƒ‰ã«é–¢ã™ã‚‹æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹
    {
        Debug.Log("Build completed with " + report.summary.result);
    }
}
```

OnPostprocessBuild() ãŒãƒ“ãƒ«ãƒ‰å®Œäº†ç›´å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã§ã€å¼•æ•°ã«ã¯ãƒ“ãƒ«ãƒ‰ã«é–¢ã™ã‚‹æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

[callbackOrder](https://docs.unity3d.com/ja/2021.1/ScriptReference/Build.IOrderedCallback-callbackOrder.html) ã§å®Ÿè¡Œé †ã‚’å®šç¾©ã§ãã€å°ã•ã„å€¤ã®æ–¹ãŒå…ˆã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã€å®Ÿéš›ã«ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```log
Build completed with Unknown
```

ãƒ“ãƒ«ãƒ‰ãŒç¢ºå®Ÿã«æˆåŠŸã—ã¦ã„ã‚‹å ´åˆã«ã‚‚ report.summary.result ã«ã¯ [BuildResult.Unknown](https://docs.unity3d.com/ScriptReference/Build.Reporting.BuildResult.Unknown.html) ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚

ã—ã‹ã—æœ¬æ¥ã§ã‚ã‚Œã°ãƒ“ãƒ«ãƒ‰çµæœã«å¿œã˜ãŸå€¤ã€ã¤ã¾ã‚ŠæˆåŠŸæ™‚ã¯ Succeededã€å¤±æ•—æ™‚ã¯ Failedã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯ Cancelled ãŒå…¥ã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

ã¡ãªã¿ã« UnityEditor ã® Build Settings > Build ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ãŸå ´åˆã‚‚ã€batachmode ã§ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ãŸå ´åˆã‚‚ã€`callbackOrder` ã‚’ã‚ã‚‰ã‚†ã‚‹å€¤ã«å¤‰æ›´ã—ãŸå ´åˆã‚‚çµæœã¯åŒæ§˜ã§ã—ãŸã€‚

ä»¥ä¸Šã®ã‚ˆã†ã« IPostprocessBuildWithReport ã«ã‚ˆã‚Šå–å¾—ã§ãã‚‹ãƒ“ãƒ«ãƒ‰æƒ…å ±ã«ã¯èª¤ã£ãŸæƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ã¾ãŸã€ç§ãŒèª¿ã¹ãŸç¯„å›²ã§ã¯ [BuildReport.summary.result](https://docs.unity3d.com/ScriptReference/Build.Reporting.BuildSummary-result.html) ã®ä»–ã«ã‚‚ä»¥ä¸‹ã®å€¤ãŒèª¤ã£ã¦ã„ã¾ã—ãŸã€‚

- [BuildReport.summary.totalTime](https://docs.unity3d.com/ScriptReference/Build.Reporting.BuildSummary-totalTime.html)
- [BuildReport.summary.buildEndedAt](https://docs.unity3d.com/ScriptReference/Build.Reporting.BuildSummary-buildEndedAt.html)
- [BuildReport.summary.buildStartedAt](https://docs.unity3d.com/ScriptReference/Build.Reporting.BuildSummary-buildStartedAt.html)

ã“ã®å•é¡Œã¯æ—¢ã«ä»¥ä¸‹ã® issue ã§å ±å‘Šã•ã‚Œã¦ã„ã¾ã™ãŒã€æ®‹å¿µãªãŒã‚‰ Won't Fix ã¨ã®ã“ã¨ã§ã™ã€‚

- [Unity Issue Tracker - [BuildReport] report in IPostProcessBuildWithReport provides incorrect information](https://issuetracker.unity3d.com/issues/buildreport-report-in-ipostprocessbuildwithreport-provides-incorrect-information)
- [Unity Issue Tracker - [BuildReport] summary.result in IPostprocessBuildWithReport always return "Unknown"](https://issuetracker.unity3d.com/issues/ipostprocessbuildwithreport-always-return-unknown-even-when-the-actual-build-has-succeeded)

## å›é¿æ–¹æ³•

ã“ã®å•é¡Œã®å›é¿æ–¹æ³•ã‚’ 2 ã¤ç´¹ä»‹ã—ã¾ã™ã€‚

### 1. BuildPipeline.BuildPlayer() ã®æˆ»ã‚Šå€¤ã‹ã‚‰ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’å–å¾—ã™ã‚‹

1 ã¤ç›®ã®å›é¿æ–¹æ³•ã¯ [BuildPipeline.BuildPlayer()](https://docs.unity3d.com/ScriptReference/BuildPipeline.BuildPlayer.html) ã®æˆ»ã‚Šå€¤ã‹ã‚‰ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã€ã¨ã„ã†æ–¹æ³•ã§ã™ã€‚

ä»¥ä¸‹ã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç¤ºã—ã¾ã™ã€‚

```cs
using UnityEditor;
using UnityEngine;
using UnityEditor.Build.Reporting;

public class BuildPlayerExample
{
    [MenuItem("Build/StandaloneOSX")]
    public static void Build()
    {
        var buildPlayerOptions = new BuildPlayerOptions
        {
            scenes = new[] { "Assets/Scenes/SampleScene.unity" },
            locationPathName = "Outputs",
            target = BuildTarget.StandaloneOSX,
            options = BuildOptions.Development,
        };

        // æ­£ã—ã„ãƒ“ãƒ«ãƒ‰æƒ…å ±ãŒè¿”ã£ã¦ãã‚‹
        var report = BuildPipeline.BuildPlayer(buildPlayerOptions); 
        
        // Build completed with Succeeded
        Debug.Log("Build completed with " + report.summary.result); 
    }
}
```

ãŸã ã—ã€ã“ã®å ´åˆã¯ `BuildPipeline.BuildPlayer()` ã®å®Ÿè¡Œçµæœã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ä¸Šè¨˜ã®ã‚ˆã†ã« MenuItem ãªã©ã®ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œã®ãŸã‚ã®å°ç·šã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### 2. Library/LastBuild.buildreport ã‹ã‚‰ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’å–å¾—ã™ã‚‹

ãƒ“ãƒ«ãƒ‰æƒ…å ±ã¯ãƒ“ãƒ«ãƒ‰çµ‚äº†æ™‚ã« `Library/LastBuild.buildreport` ã¸å‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã€ã¨ã„ã†ã®ãŒ 2 ã¤ç›®ã®æ–¹æ³•ã§ã™ã€‚

ä»¥ä¸‹ã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç¤ºã—ã¾ã™ã€‚

```cs
public sealed class BuildReportLoader
{
    private readonly string _buildReportDir =
        $"{Path.Combine(Application.dataPath, LastBuildReportsDirectoryName)}";

    private readonly string _lastBuildReportsAssetPath =
        $"{Path.Combine("Assets", LastBuildReportsDirectoryName, LastBuildReportFileName)}";

    private const string LastBuildReportsDirectoryName = "LastBuildReports";
    private const string LibraryDirectoryName = "Library";
    private const string LastBuildReportFileName = "LastBuild.buildreport";

    public void LoadBuildReport()
    {
        var projectRootPath = Directory.GetParent(Application.dataPath)?.FullName;
        if (string.IsNullOrEmpty(projectRootPath))
        {
            return;
        }

        var lastBuildReportPath = $"{Path.Combine(projectRootPath, LibraryDirectoryName, LastBuildReportFileName)}";
        if (!File.Exists(lastBuildReportPath))
        {
            return;
        }

        if (!Directory.Exists(_buildReportDir))
        {
            Directory.CreateDirectory(_buildReportDir);
        }

        File.Copy(lastBuildReportPath, _lastBuildReportsAssetPath, true);

        AssetDatabase.ImportAsset(_lastBuildReportsAssetPath);

        var report = AssetDatabase.LoadAssetAtPath<BuildReport>(_lastBuildReportsAssetPath);
        
        Debug.Log("Build completed with " + report.summary.result);
    }
}
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ `Library/LastBuild.buildreport` ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã«ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ—¦ Assets å†…ã¸ã‚³ãƒ”ãƒ¼ã—ã¦ã‹ã‚‰ AssetDatabase.LoadAssetAtPath() ã§èª­ã¿è¾¼ã‚€ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ã¡ãªã¿ã« [BuildReportInspector](https://github.com/Unity-Technologies/BuildReportInspector) ã‚„ [GhaUnityBuildReporter](https://github.com/VeyronSakai/GhaUnityBuildReporter) ã§ã¯ã“ã®æ–¹æ³•ã§ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

:::message alert
ã—ã‹ã—ã€IPostprocessBuildWithReport.OnPostprocessBuild() ã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã¯ã¾ã  `Library/LastBuild.buildreport` ã¸ã®å‡ºåŠ›ã¯è¡Œã‚ã‚Œã¦ãŠã‚Šã¾ã›ã‚“ã€‚

ã‚ˆã£ã¦ IPostprocessBuildWithReport.OnPostprocessBuild() å†…ã§ä¸Šè¨˜ã®å‡¦ç†ã‚’å‘¼ã³å‡ºã—ã¦ã‚‚ `Library/LastBuild.buildreport` ã¯è¦‹ã¤ã‹ã‚‰ãšå¤±æ•—ã™ã‚‹ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ã“ã®å•é¡Œã®å›é¿æ–¹æ³•ã¯å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ãƒ“ãƒ«ãƒ‰çµ‚äº†æ™‚ç‚¹ã‹ã‚‰ã•ã‚‰ã«å¾Œã‚ã«ã‚ºãƒ©ã™ã“ã¨ã§ã™ã€‚

ä¾‹ãˆã° batchmode ã§ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ EditorApplication.quitting ã« `Library/LastBuild.buildreport` ã®èª­ã¿è¾¼ã¿å‡¦ç†ã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ã§ã“ã®å•é¡Œã‚’å›é¿ã§ãã¾ã™ã€‚
:::
