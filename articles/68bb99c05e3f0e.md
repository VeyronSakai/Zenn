---
title: "UniTask èª­è§£ãƒ¡ãƒ¢"
emoji: "ğŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Unity]
published: false
---

## æ¦‚è¦

[Cysharp/UniTask](https://github.com/Cysharp/UniTask) ã®å†…éƒ¨å®Ÿè£…ã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã éš›ã®èª­è§£ãƒ¡ãƒ¢ã§ã™ã€‚

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

å…¨ä½“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆæ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```sh
.
â”œâ”€â”€ docs
â”‚Â Â  â””â”€â”€ api
â””â”€â”€ src
    â”œâ”€â”€ UniTask
    â”‚Â Â  â”œâ”€â”€ Assets
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Editor
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Plugins
    â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ UniTask
    â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ Editor
    â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ Runtime
    â”‚Â Â  â”‚Â Â  â”‚Â Â          â”œâ”€â”€ CompilerServices
    â”‚Â Â  â”‚Â Â  â”‚Â Â          â”œâ”€â”€ External
    â”‚Â Â  â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ Addressables
    â”‚Â Â  â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ DOTween
    â”‚Â Â  â”‚Â Â  â”‚Â Â          â”‚Â Â  â””â”€â”€ TextMeshPro
    â”‚Â Â  â”‚Â Â  â”‚Â Â          â”œâ”€â”€ Internal
    â”‚Â Â  â”‚Â Â  â”‚Â Â          â”œâ”€â”€ Linq
    â”‚Â Â  â”‚Â Â  â”‚Â Â          â”‚Â Â  â””â”€â”€ UnityExtensions
    â”‚Â Â  â”‚Â Â  â”‚Â Â          â””â”€â”€ Triggers
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ RuntimeUnitTestToolkit
    â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ Editor
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Scenes
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ StreamingAssets
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ TempAsm
    â”‚Â Â  â”‚Â Â  â””â”€â”€ Tests
    â”‚Â Â  â”‚Â Â      â”œâ”€â”€ Editor
    â”‚Â Â  â”‚Â Â      â””â”€â”€ Resources
    â”‚Â Â  â”œâ”€â”€ ProjectSettings
    â”‚Â Â  â””â”€â”€ UserSettings
    â”œâ”€â”€ UniTask.Analyzer
    â”‚Â Â  â””â”€â”€ Properties
    â”œâ”€â”€ UniTask.NetCore
    â”‚Â Â  â””â”€â”€ NetCore
    â”œâ”€â”€ UniTask.NetCoreSandbox
    â””â”€â”€ UniTask.NetCoreTests
        â””â”€â”€ Linq

```

UniTask ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æœ¬ä½“ã¯ [src/UniTask/Assets/Plugins/UniTask/](https://github.com/Cysharp/UniTask/tree/master/src/UniTask/Assets/Plugins/UniTask) ã«å­˜åœ¨ã—ã¦ãŠã‚Šã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æœ¬ä½“ã®ã¿ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```sh
.
â”œâ”€â”€ Editor
â””â”€â”€ Runtime
    â”œâ”€â”€ CompilerServices
    â”œâ”€â”€ External
    â”‚Â Â  â”œâ”€â”€ Addressables
    â”‚Â Â  â”œâ”€â”€ DOTween
    â”‚Â Â  â””â”€â”€ TextMeshPro
    â”œâ”€â”€ Internal
    â”œâ”€â”€ Linq
    â”‚Â Â  â””â”€â”€ UnityExtensions
    â””â”€â”€ Triggers
```

æœ¬è¨˜äº‹ã§ã¯ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã®ã¿æ³¨ç›®ã—ã€ã‚³ãƒ¼ãƒ‰ã‚’èª­è§£ã—ã¦ã„ãã¾ã™ã€‚

## å„ namespace é–“ã®ä¾å­˜é–¢ä¿‚

ç™»å ´ã™ã‚‹ namespace ã¯å®Ÿè³ªçš„ã«ã¯ä»¥ä¸‹ã® 5 ã¤ã§ã™[^1]ã€‚

- Cysharp.Threading.Tasks
- Cysharp.Threading.Tasks.CompilerServices
- Cysharp.Threading.Tasks.Internal
- Cysharp.Threading.Tasks.Linq
- Cysharp.Threading.Tasks.Triggers

ã“ã‚Œã‚‰ã® namespace ã®ä¾å­˜é–¢ä¿‚ã‚’ç¤ºã—ãŸå›³ãŒä»¥ä¸‹ã§ã™ã€‚(Cysharp.Threading. ã®éƒ¨åˆ†ã¯çœç•¥ã—ã¦ã„ã¾ã™)

```mermaid
flowchart LR
  Tasks --> Tasks.CompilerServices

  Tasks --> Tasks.Internal

  Tasks --> Tasks.Triggers

  Tasks.Linq --> Tasks.Internal
```

[^1]: å³å¯†ã«ã¯ AsyncMethodBuilderAttribute ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã®ã¿ System.Runtime.CompilerServices ã¨ã„ã† namepspace ã«å±ã—ã¦ã„ã¾ã™ãŒèª¬æ˜ã‹ã‚‰ã¯çœã„ã¦ã„ã¾ã™ã€‚

## ã‚¯ãƒ©ã‚¹å›³

## ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ

[PlayerLoopHelper](https://github.com/Cysharp/UniTask/blob/3121903fa3f35daba980a9c602a0fc6aff5f1eea/src/UniTask/Assets/Plugins/UniTask/Runtime/PlayerLoopHelper.cs#L179) ã¨ã„ã† static ã‚¯ãƒ©ã‚¹ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ [Init()](https://github.com/Cysharp/UniTask/blob/3121903fa3f35daba980a9c602a0fc6aff5f1eea/src/UniTask/Assets/Plugins/UniTask/Runtime/PlayerLoopHelper.cs#L293) ãƒ¡ã‚½ãƒƒãƒ‰ã« RuntimeInitializeOnLoadMethod attribute ãŒä»˜ä¸ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãã®ãŸã‚ PlayerLoopHelper.Init() ãŒãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•ç›´å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ã€ã„ã‚ã‚†ã‚‹ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¨ãªã‚Šã¾ã™ã€‚

### PlayerLoopHelper.Init()

PlayerLoopHelper.Init() ã«ã¤ã„ã¦é‡è¦ãªéƒ¨åˆ†ã®ã¿æŠœç²‹ã™ã‚‹ã¨å¤§ã¾ã‹ã«ä»¥ä¸‹ã®ã‚ˆã†ãªå‡¦ç†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```cs
static void Init()
{
    // ç¾åœ¨ã® UnitySynchronizationContext ã‚’å–å¾—
    unitySynchronizationContext = SynchronizationContext.Current;

    // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ ID ã‚’å–å¾—
    mainThreadId = Thread.CurrentThread.ManagedThreadId;

    // ç¾åœ¨ã® PlayerLoop ã‚’å–å¾—
    var playerLoop = PlayerLoop.GetCurrentPlayerLoop();

    Initialize(ref playerLoop);
}
```

PlayerLoop ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã§è©³ã—ãèª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
- https://docs.unity3d.com/ja/2020.3/ScriptReference/LowLevel.PlayerLoop.html
- https://tsubakit1.hateblo.jp/entry/2018/04/17/233000
- https://www.hanachiru-blog.com/entry/2021/08/23/120000

```cs
public static void Initialize(ref PlayerLoopSystem playerLoop, InjectPlayerLoopTimings injectTimings = InjectPlayerLoopTimings.All)
{
    yielders = new ContinuationQueue[16];
    runners = new PlayerLoopRunner[16];

    var copyList = playerLoop.subSystemList.ToArray();

    // Initialization
    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.Initialization),
        InjectPlayerLoopTimings.Initialization, 0, true,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerYieldInitialization), typeof(UniTaskLoopRunners.UniTaskLoopRunnerInitialization), PlayerLoopTiming.Initialization);

    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.Initialization),
        InjectPlayerLoopTimings.LastInitialization, 1, false,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastYieldInitialization), typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastInitialization), PlayerLoopTiming.LastInitialization);

    // EarlyUpdate
    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.EarlyUpdate),
        InjectPlayerLoopTimings.EarlyUpdate, 2, true,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerYieldEarlyUpdate), typeof(UniTaskLoopRunners.UniTaskLoopRunnerEarlyUpdate), PlayerLoopTiming.EarlyUpdate);

    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.EarlyUpdate),
        InjectPlayerLoopTimings.LastEarlyUpdate, 3, false,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastYieldEarlyUpdate), typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastEarlyUpdate), PlayerLoopTiming.LastEarlyUpdate);

    // FixedUpdate
    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.FixedUpdate),
        InjectPlayerLoopTimings.FixedUpdate, 4, true,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerYieldFixedUpdate), typeof(UniTaskLoopRunners.UniTaskLoopRunnerFixedUpdate), PlayerLoopTiming.FixedUpdate);

    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.FixedUpdate),
        InjectPlayerLoopTimings.LastFixedUpdate, 5, false,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastYieldFixedUpdate), typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastFixedUpdate), PlayerLoopTiming.LastFixedUpdate);

    // PreUpdate
    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.PreUpdate),
        InjectPlayerLoopTimings.PreUpdate, 6, true,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerYieldPreUpdate), typeof(UniTaskLoopRunners.UniTaskLoopRunnerPreUpdate), PlayerLoopTiming.PreUpdate);

    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.PreUpdate),
        InjectPlayerLoopTimings.LastPreUpdate, 7, false,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastYieldPreUpdate), typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastPreUpdate), PlayerLoopTiming.LastPreUpdate);

    // Update
    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.Update),
        InjectPlayerLoopTimings.Update, 8, true,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerYieldUpdate), typeof(UniTaskLoopRunners.UniTaskLoopRunnerUpdate), PlayerLoopTiming.Update);

    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.Update),
        InjectPlayerLoopTimings.LastUpdate, 9, false,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastYieldUpdate), typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastUpdate), PlayerLoopTiming.LastUpdate);

    // PreLateUpdate
    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.PreLateUpdate),
        InjectPlayerLoopTimings.PreLateUpdate, 10, true,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerYieldPreLateUpdate), typeof(UniTaskLoopRunners.UniTaskLoopRunnerPreLateUpdate), PlayerLoopTiming.PreLateUpdate);

    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.PreLateUpdate),
        InjectPlayerLoopTimings.LastPreLateUpdate, 11, false,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastYieldPreLateUpdate), typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastPreLateUpdate), PlayerLoopTiming.LastPreLateUpdate);

    // PostLateUpdate
    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.PostLateUpdate),
        InjectPlayerLoopTimings.PostLateUpdate, 12, true,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerYieldPostLateUpdate), typeof(UniTaskLoopRunners.UniTaskLoopRunnerPostLateUpdate), PlayerLoopTiming.PostLateUpdate);

    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.PostLateUpdate),
        InjectPlayerLoopTimings.LastPostLateUpdate, 13, false,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastYieldPostLateUpdate), typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastPostLateUpdate), PlayerLoopTiming.LastPostLateUpdate);

    // TimeUpdate
    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.TimeUpdate),
        InjectPlayerLoopTimings.TimeUpdate, 14, true,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerYieldTimeUpdate), typeof(UniTaskLoopRunners.UniTaskLoopRunnerTimeUpdate), PlayerLoopTiming.TimeUpdate);

    InsertLoop(copyList, injectTimings, typeof(PlayerLoopType.TimeUpdate),
        InjectPlayerLoopTimings.LastTimeUpdate, 15, false,
        typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastYieldTimeUpdate), typeof(UniTaskLoopRunners.UniTaskLoopRunnerLastTimeUpdate), PlayerLoopTiming.LastTimeUpdate);

    // Insert UniTaskSynchronizationContext to Update loop
    var i = FindLoopSystemIndex(copyList, typeof(PlayerLoopType.Update));
    copyList[i].subSystemList = InsertUniTaskSynchronizationContext(copyList[i]);

    playerLoop.subSystemList = copyList;
    PlayerLoop.SetPlayerLoop(playerLoop);
}
```

## å‚è€ƒæ–‡çŒ®

- [UniTaskã‚’ä½¿ã£ãŸè©±](https://hackerslab.aktsk.jp/2019/12/05/124250)

## ã¾ã¨ã‚
